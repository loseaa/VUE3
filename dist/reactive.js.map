{
  "version": 3,
  "sources": ["../packages/shared/src/utils.ts", "../packages/reactive/src/effect.ts", "../packages/reactive/src/activeEffect.ts", "../packages/reactive/src/basehandler.ts", "../packages/reactive/src/reactive.ts"],
  "sourcesContent": ["export function isObject(value: any): value is Record<any, any> {\r\n    return value !== null && typeof value === 'object'\r\n}", "export function effect(fn: Function, options: any = {}) {\r\n\tlet _effect = new ReactiveEffect(\r\n\t\tfn,\r\n\t\toptions.scheduler ||\r\n\t\t\t(() => {\r\n\t\t\t\t_effect.run();\r\n\t\t\t})\r\n\t);\r\n\t_effect.run();\r\n\tlet runner = _effect.run.bind(_effect);\r\n\t(runner as any).effect = _effect;\r\n\treturn runner;\r\n}\r\nexport let activeEffect: ReactiveEffect | undefined;\r\n\r\nfunction preEffectClean(effect: ReactiveEffect) {\r\n\teffect.trackId++;\r\n\teffect.depsLength = 0;\r\n}\r\n\r\nfunction postCleanEffect(effect: ReactiveEffect) {\r\n\tconst len = effect.deps.length;\r\n\tif (effect.depsLength < len) {\r\n\t\tfor (let i = effect.depsLength; i < len; i++) {\r\n\t\t\tcleanEffectDeps(effect, effect.deps[i]);\r\n\t\t}\r\n\t\teffect.deps.length = effect.depsLength;\r\n\t}\r\n}\r\n\r\nexport class ReactiveEffect {\r\n\tactive = true;\r\n\ttrackId = 0;\r\n\tdeps = new Array();\r\n\t_isRunning = false;\r\n\tdepsLength = 0;\r\n\tconstructor(\r\n\t\tpublic fn: Function,\r\n\t\tpublic scheduler: any\r\n\t) {}\r\n\r\n\trun() {\r\n\t\t// \u5982\u679C\u4E0D\u662Factive\u72B6\u6001\uFF0C\u76F4\u63A5\u6267\u884C\u51FD\u6570 \u4E0D\u6267\u884C\u6536\u96C6\r\n\t\tif (!this.active) {\r\n\t\t\treturn this.fn();\r\n\t\t}\r\n\t\tlet lastEffect = activeEffect;\r\n\t\tactiveEffect = this;\r\n\t\tpreEffectClean(this);\r\n\t\tthis._isRunning = true;\r\n\t\tconst result = this.fn();\r\n\t\tthis._isRunning = false;\r\n\t\tpostCleanEffect(this);\r\n\t\tactiveEffect = lastEffect;\r\n\t\treturn result;\r\n\t}\r\n}\r\n\r\nfunction cleanEffectDeps(effect: ReactiveEffect, dep: Map<ReactiveEffect, number>) {\r\n\tdep.delete(effect);\r\n\tif (dep.size === 0) {\r\n\t\t(dep as any).cleanup();\r\n\t}\r\n}\r\n\r\nexport function trackEffect(activeEffect: ReactiveEffect, dep: Map<ReactiveEffect, number>) {\r\n\t//trackID \u7528\u4E8E\u6807\u8BB0\u8BE5effect\u662F\u5426\u5DF2\u7ECF\u88AB\u6536\u96C6\u8FC7\u4E86 \u4FDD\u8BC1\u4E00\u8F6E\u6267\u884C\u8FC7\u7A0B\u4E2D\u53EA\u4F1A\r\n\t// \u6536\u96C6\u4E00\u6B21\u76F8\u540C\u7684\u4F9D\u8D56\r\n\tif (dep.get(activeEffect) === activeEffect.trackId) {\r\n\t\treturn;\r\n\t}\r\n\t\r\n\tactiveEffect.deps[activeEffect.depsLength++] = dep;\r\n\tif (activeEffect.deps[activeEffect.depsLength] === dep) {\r\n\t\t// \u672C\u6B21\u4F9D\u8D56\u4E0E\u4E0A\u6B21\u4F9D\u8D56\u76F8\u540C \u76F4\u63A5\u590D\u7528\r\n\t\tactiveEffect.depsLength++;\r\n\t} else {\r\n\t\t// \u4E0D\u76F8\u540C\u5219\u9700\u8981\u6E05\u7406\u4E0A\u6B21\u4F9D\u8D56\r\n\t\tlet oldDep = activeEffect.deps[activeEffect.depsLength];\r\n\t\tif (oldDep) {\r\n\t\t\tcleanEffectDeps(activeEffect, oldDep);\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t}\r\n\tdep.set(activeEffect, activeEffect.trackId);\r\n}\r\n\r\nexport function triggerEffects(dep: Map<ReactiveEffect, number>) {\r\n\tdep.forEach((_, effect) => {\r\n\t\tif (effect._isRunning) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (effect.scheduler) {\r\n\t\t\teffect.scheduler();\r\n\t\t}\r\n\t});\r\n}\r\n", "\r\nimport { activeEffect, ReactiveEffect, trackEffect, triggerEffects } from \"./effect.js\";\r\n\r\nfunction creatDepMap(cleanup:()=>void,_name?:string){ \r\n    let res= new Map<ReactiveEffect,number>();\r\n    (res as any).cleanup = cleanup;\r\n    (res as any)._name = _name;\r\n    return res;\r\n}\r\n\r\nconst targetMap = new WeakMap<any, Map<string | symbol, Map<ReactiveEffect,number>>>();\r\nexport function track(target:any, key:string | symbol) {\r\n    if(activeEffect){\r\n        let depsMap = targetMap.get(target);\r\n        if(!depsMap) {\r\n            targetMap.set(target, (depsMap = new Map<string | symbol, Map<ReactiveEffect,number>>()));\r\n        }\r\n\r\n        let dep = depsMap.get(key);\r\n        if(!dep) {\r\n            depsMap.set(key, (dep = creatDepMap(()=>{depsMap.delete(key);},String(key))));\r\n        }\r\n        trackEffect(activeEffect,dep);\r\n    }\r\n}\r\n\r\nexport function trigger(target:any, key:string | symbol) {\r\n    const depsMap = targetMap.get(target);\r\n    if(!depsMap) return;\r\n    const dep = depsMap.get(key);\r\n    if(!dep) return;\r\n    triggerEffects(dep);\r\n}\r\n\r\n\r\n\r\n", "\r\nimport { isObject } from \"@VUE3/shared\";\r\nimport { track, trigger } from \"./activeEffect.js\";\r\nimport { reactive } from \"./reactive.js\";\r\n\r\nexport const mutableHandlers:ProxyHandler<any>={\r\n    get(target,key,receiver){\r\n        if(key===\"__v_isReactive\"){\r\n            return true;\r\n        }   \r\n        track(target,key);\r\n        let res=Reflect.get(target,key,receiver);\r\n        if(isObject(res)){\r\n            return reactive(res);\r\n        }\r\n        return res;\r\n    },\r\n    set(target,key,value,receiver){\r\n        let oldValue=target[key];\r\n        const result = Reflect.set(target,key,value,receiver);\r\n        if(oldValue!==value){\r\n            trigger(target,key);\r\n        }\r\n        return result;\r\n    }\r\n}", "import { isObject } from '@VUE3/shared';\r\nimport { mutableHandlers } from './basehandler.js';\r\nconst reactiveMap = new WeakMap();\r\n\r\nexport function reactive(target: any) {\r\n\treturn creatReactiveObject(target);\r\n}\r\n\r\nfunction creatReactiveObject(target: any) {\r\n\tif (!isObject(target)) {\r\n\t\tconsole.warn(`reactive ${target} \u5FC5\u987B\u662F\u4E00\u4E2A\u5BF9\u8C61`);\r\n\t\treturn target;\r\n\t}\r\n\tif (reactiveMap.has(target)) {\r\n\t\treturn reactiveMap.get(target);\r\n\t}\r\n\tif ((target as any).__v_isReactive) {\r\n\t\treturn target;\r\n\t}\r\n\r\n\tconst proxy = new Proxy(target, mutableHandlers);\r\n\treactiveMap.set(target, proxy);\r\n\treturn proxy;\r\n}\r\n"],
  "mappings": "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",
  "names": ["effect", "activeEffect"]
}
